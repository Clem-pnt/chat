<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat en temps r√©el</title>
  <style>
    /* Ton style reste inchang√©, ajoute cette partie pour l'image de profil */
    .profile-img {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div id="authPage" class="auth-page">
    <button class="auth-button" id="loginButton">Se connecter</button>
    <button class="auth-button" id="createAccountButton">Cr√©er un compte</button>
    <button class="auth-button" id="guestButton">Continuer en invit√©</button>
  </div>

  <header id="header" style="display: none;">
    <div>
      <strong>Chat en temps r√©el</strong><br/>
      <span id="pseudo"></span>
    </div>
    <button id="logoutButton">D√©connexion</button>
    <button id="toggleTheme">üåô</button>
  </header>

  <div id="chat" style="display: none;"></div>

  <footer id="footer" style="display: none;">
    <input type="text" id="messageInput" placeholder="√âcris ton message..." />
    <button onclick="sendMessage()">Envoyer</button>
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    // Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCQhw69gH9pZDngyp82OS4nKHy_MhbdoE0",
      authDomain: "chat-14381.firebaseapp.com",
      projectId: "chat-14381",
      storageBucket: "chat-14381.firebasestorage.app",
      messagingSenderId: "114036601860",
      appId: "1:114036601860:web:3d792be8e5be3ad1c23151",
      measurementId: "G-W1W14M3J92"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    // Fonction d'authentification et de connexion
    let user = null;

    // Fonction pour afficher la page de connexion
    function showAuthPage() {
      document.getElementById("authPage").style.display = "flex";
      document.getElementById("header").style.display = "none";
      document.getElementById("chat").style.display = "none";
      document.getElementById("footer").style.display = "none";

      document.getElementById("loginButton").onclick = function () {
        const email = prompt("Entrez votre email :");
        const password = prompt("Entrez votre mot de passe :");

        auth.signInWithEmailAndPassword(email, password).then((userCredential) => {
          user = userCredential.user;
          showChatPage(user.displayName, user.photoURL || 'defaultProfile.png');
        }).catch((error) => {
          alert("Erreur de connexion : " + error.message);
        });
      };

      document.getElementById("createAccountButton").onclick = function () {
        const email = prompt("Entrez votre email :");
        const password = prompt("Choisissez un mot de passe :");

        // Demander une photo de profil
        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = "image/*";
        fileInput.onchange = function (event) {
          const file = event.target.files[0];
          const storageRef = storage.ref().child("profile_pics/" + file.name);
          storageRef.put(file).then(snapshot => {
            snapshot.ref.getDownloadURL().then(url => {
              createAccount(email, password, url);
            });
          }).catch(error => {
            alert("Erreur lors du t√©l√©chargement de la photo de profil : " + error.message);
          });
        };
        fileInput.click();
      };

      document.getElementById("guestButton").onclick = function () {
        user = { displayName: "Invit√© " + Math.floor(Math.random() * 1000) };
        showChatPage(user.displayName, 'defaultProfile.png');
      };
    }

    // Cr√©er un compte avec photo de profil
    function createAccount(email, password, photoURL) {
      auth.createUserWithEmailAndPassword(email, password).then((userCredential) => {
        user = userCredential.user;
        user.updateProfile({
          displayName: email.split('@')[0], // Utilisation de l'email pour le pseudo
          photoURL: photoURL || 'defaultProfile.png'
        });
        showChatPage(user.displayName, user.photoURL);
      }).catch((error) => {
        alert("Erreur de cr√©ation de compte : " + error.message);
      });
    }

    // Fonction pour afficher la page de chat
    function showChatPage(pseudo, photoURL) {
      document.getElementById("authPage").style.display = "none";
      document.getElementById("header").style.display = "flex";
      document.getElementById("chat").style.display = "block";
      document.getElementById("footer").style.display = "flex";

      document.getElementById("pseudo").textContent = `Connect√© en tant que : ${pseudo}`;

      // Fonction de d√©connexion
      document.getElementById("logoutButton").onclick = function () {
        auth.signOut().then(() => {
          user = null;
          showAuthPage();
        });
      };

      // Fonction d'envoi de message
      const chatBox = document.getElementById("chat");
      function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();
        if (message === '') return;

        db.collection("messages").add({
          pseudo: pseudo,
          message: message,
          photoURL: photoURL,
          timestamp: new Date()
        });

        input.value = '';
        input.focus();
      }

      db.collection("messages")
        .orderBy("timestamp")
        .onSnapshot(snapshot => {
          chatBox.innerHTML = "";
          let lastAuthor = null;
          let lastBubble = null;

          snapshot.forEach(doc => {
            const data = doc.data();
            const isMine = data.pseudo === pseudo;
            const isSameAuthor = data.pseudo === lastAuthor;

            if (isSameAuthor && lastBubble) {
              const msg = document.createElement("div");
              msg.className = "sub-message";
              msg.textContent = data.message;
              lastBubble.querySelector(".messages").appendChild(msg);
            } else {
              const bubble = document.createElement("div");
              bubble.className = `message-block ${isMine ? "mine" : "other"}`;

              bubble.innerHTML = `
                <div class="author">
                  <img src="${data.photoURL || 'defaultProfile.png'}" class="profile-img" />
                  ${data.pseudo}<span class="time">${new Date(data.timestamp.toDate()).toLocaleTimeString()}</span>
                </div>
                <div class="messages">
                  <div class="sub-message">${data.message}</div>
                </div>
              `;

              chatBox.appendChild(bubble);
              lastBubble = bubble;
            }

            lastAuthor = data.pseudo;
          });

          chatBox.scrollTop = chatBox.scrollHeight;
        });

      document.getElementById("messageInput").addEventListener("keydown", function (e) {
        if (e.key === "Enter") sendMessage();
      });
    }

    // üåô Toggle th√®me
    const toggleButton = document.getElementById("toggleTheme");
    const body = document.body;

    function applyTheme(theme) {
      if (theme === "dark") {
        body.classList.add("dark");
        toggleButton.textContent = "‚òÄÔ∏è";
      } else {
        body.classList.remove("dark");
        toggleButton.textContent = "üåô";
      }
      localStorage.setItem("theme", theme);
    }

    toggleButton.onclick = () => {
      const newTheme = body.classList.contains("dark") ? "light" : "dark";
      applyTheme(newTheme);
    };

    // Appliquer th√®me au chargement
    const savedTheme = localStorage.getItem("theme") || "light";
    applyTheme(savedTheme);

    // V√©rifier si l'utilisateur est d√©j√† connect√©
    auth.onAuthStateChanged((userCredential) => {
      if (userCredential) {
        user = userCredential.user;
        showChatPage(user.displayName, user.photoURL || 'defaultProfile.png');
      } else {
        showAuthPage();
      }
    });

  </script>
</body>
</html>
