<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DiscLite</title>
  <style>
    /* Styles prÃ©cÃ©dents ici... */
  </style>
</head>
<body>

  <div id="toast"></div>

  <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ™/ðŸŒž</button>

  <!-- Connexion -->
  <div id="authPage" class="page active">
    <div class="auth-box">
      <h1>DiscLite</h1>
      <input type="text" id="pseudoInput" class="input" placeholder="Entrez votre pseudo" />
      <button id="guestButton" class="auth-button">Continuer en invitÃ©</button>
    </div>
  </div>

  <!-- Chat -->
  <div id="chatPage" class="page">
    <div class="header-chat">
      <strong id="pseudo"></strong>
    </div>
    <div id="chat" class="chat-box"></div>
    <div class="footer">
      <input type="text" id="messageInput" placeholder="Ã‰cris ton message..." />
      <button class="send" onclick="sendMessage()">Envoyer</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCQhw69gH9pZDngyp82OS4nKHy_MhbdoE0",
      authDomain: "chat-14381.firebaseapp.com",
      projectId: "chat-14381",
      storageBucket: "chat-14381.appspot.com",
      messagingSenderId: "114036601860",
      appId: "1:114036601860:web:3d792be8e5be3ad1c23151"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let currentUser = null;

    // Fonction de toast
    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = "show";
      setTimeout(() => {
        toast.className = toast.className.replace("show", "");
      }, 3000);
    }

    // Fonction d'affichage de la page de chat
    function showChatPage(user) {
      document.getElementById("authPage").classList.remove("active");
      document.getElementById("chatPage").classList.add("active");
      document.getElementById("pseudo").textContent = `ConnectÃ© en tant que : ${user.displayName}`;
      loadMessages();
      setTimeout(() => {
        document.getElementById("messageInput").focus();
      }, 300);
    }

    // Fonction pour envoyer un message
    function sendMessage() {
      const input = document.getElementById("messageInput");
      const msg = input.value.trim();
      const replyTo = input.dataset.replyTo || null;
      if (msg === "") return;
      db.collection("messages").add({
        pseudo: currentUser.displayName,
        message: msg,
        reactions: {},
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        replyingTo: replyTo
      });
      input.value = "";
      delete input.dataset.replyTo; 
    }

    // Fonction pour rÃ©pondre Ã  un message
    function replyToMessage(messageId, messageText, pseudo) {
      const input = document.getElementById("messageInput");
      input.value = `RÃ©pondre Ã  ${pseudo}: ${messageText}`;
      input.focus();
      input.dataset.replyTo = messageId;
    }

    // Fonction pour ajouter une rÃ©action
    function addReaction(docId, emoji) {
      const ref = db.collection("messages").doc(docId);
      db.runTransaction(t => {
        return t.get(ref).then(doc => {
          const data = doc.data();
          const reactions = data.reactions || {};
          reactions[emoji] = (reactions[emoji] || 0) + 1;
          t.update(ref, { reactions });
        });
      });
    }

    // Fonction pour modifier un message
    function editMessage(docId, oldMessage) {
      const newText = prompt("Modifier le message :", oldMessage);
      if (newText && newText.trim()) {
        db.collection("messages").doc(docId).update({ message: newText.trim() });
      }
    }

    // Fonction pour supprimer un message
    function deleteMessage(docId) {
      if (confirm("Supprimer ce message ?")) {
        db.collection("messages").doc(docId).delete();
      }
    }

    // Fonction pour charger les messages
    function loadMessages() {
      const chatBox = document.getElementById("chat");
      db.collection("messages")
        .orderBy("timestamp")
        .onSnapshot(snapshot => {
          chatBox.innerHTML = "";
          snapshot.forEach(doc => {
            const data = doc.data();
            const msgDiv = document.createElement("div");
            msgDiv.className = `message-block ${data.pseudo === currentUser.displayName ? 'mine' : 'other'}`;
            msgDiv.innerHTML = `<strong>${data.pseudo}</strong><br>${data.message}`;

            // Affichage de la rÃ©ponse si elle existe
            if (data.replyingTo) {
              const replyBox = document.createElement("div");
              replyBox.className = "reply-box";
              replyBox.innerHTML = `
                <div class="message-info">RÃ©ponse Ã  ${data.replyingTo.pseudo} :</div>
                <p>${data.replyingTo.message}</p>
              `;
              msgDiv.appendChild(replyBox);
            }

            // RÃ©actions
            const reactionBar = document.createElement("div");
            reactionBar.className = "reaction-bar";
            const emojis = ["ðŸ‘", "â¤ï¸", "ðŸ˜‚"];
            emojis.forEach(emoji => {
              const reactionDiv = document.createElement("div");
              reactionDiv.className = "reaction";
              reactionDiv.innerHTML = `
                <span>${emoji}</span><span class="count">${data.reactions[emoji] || 0}</span>
              `;
              reactionDiv.onclick = () => addReaction(doc.id, emoji);
              reactionBar.appendChild(reactionDiv);
            });
            msgDiv.appendChild(reactionBar);

            // Ajouter bouton de rÃ©ponse
            const replyButton = document.createElement("button");
            replyButton.className = "reply-button";
            replyButton.innerHTML = "â†©ï¸";
            replyButton.onclick = () => replyToMessage(doc.id, data.message, data.pseudo);
            msgDiv.appendChild(replyButton);

            // Ajouter bouton de suppression/modification
            const editDeleteDiv = document.createElement("div");
            editDeleteDiv.className = "edit-delete";
            if (data.pseudo === currentUser.displayName) {
              const deleteSpan = document.createElement("span");
              deleteSpan.textContent = "Supprimer";
              deleteSpan.onclick = () => deleteMessage(doc.id);
              editDeleteDiv.appendChild(deleteSpan);

              const editSpan = document.createElement("span");
              editSpan.textContent = "Modifier";
              editSpan.onclick = () => editMessage(doc.id, data.message);
              editDeleteDiv.appendChild(editSpan);
            }
            msgDiv.appendChild(editDeleteDiv);

            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
          });
        });
    }

    // Fonction pour basculer entre le thÃ¨me clair et sombre
    function toggleTheme() {
      document.body.classList.toggle("dark");
      localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
    }

    // Fonction d'authentification
    function authenticateUser() {
      const storedUser = localStorage.getItem("user");
      if (storedUser) {
        currentUser = JSON.parse(storedUser);
        showChatPage(currentUser);
      } else {
        document.getElementById("authPage").classList.add("active");
      }
    }

    // Sauvegarder l'utilisateur dans le localStorage
    document.getElementById("guestButton").addEventListener("click", () => {
      const pseudo = document.getElementById("pseudoInput").value.trim();
      if (!pseudo) return alert("Veuillez entrer un pseudo");
      currentUser = { displayName: pseudo };
      localStorage.setItem("user", JSON.stringify(currentUser)); // Sauvegarde de l'utilisateur
      showChatPage(currentUser);
    });

    // Charger le thÃ¨me si sauvegardÃ© dans localStorage
    if (localStorage.getItem("theme") === "dark") {
      document.body.classList.add("dark");
    }

    // Initialisation
    authenticateUser();
  </script>
</body>
</html>
