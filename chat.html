<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat en temps réel</title>
  <style>
    :root {
      --bg-light: #f5f7fa;
      --bg-dark: #1e1e1e;
      --text-light: #333;
      --text-dark: #eee;
      --mine-light: #dcf8c6;
      --mine-dark: #2e4e2e;
      --other-light: #ffffff;
      --other-dark: #2c2c2c;
      --accent: #4a90e2;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-color: var(--bg-light);
      color: var(--text-light);
      transition: background 0.3s, color 0.3s;
    }

    body.dark {
      background-color: var(--bg-dark);
      color: var(--text-dark);
    }

    header {
      background: var(--accent);
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #pseudo {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }

    .message-block {
      max-width: 70%;
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 0.95rem;
      background: var(--other-light);
      align-self: flex-start;
    }

    .message-block.mine {
      background: var(--mine-light);
      align-self: flex-end;
    }

    body.dark .message-block {
      background: var(--other-dark);
    }

    body.dark .message-block.mine {
      background: var(--mine-dark);
    }

    .author {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .time {
      font-weight: normal;
      font-size: 0.75rem;
      color: #777;
      margin-left: 10px;
    }

    .messages .sub-message {
      margin-top: 2px;
      padding-top: 2px;
    }

    footer {
      display: flex;
      padding: 0.75rem;
      background: #fff;
      border-top: 1px solid #ccc;
    }

    body.dark footer {
      background: #2c2c2c;
      border-color: #444;
    }

    input[type="text"] {
      flex: 1;
      padding: 0.6rem 1rem;
      border: 1px solid #ccc;
      border-radius: 20px;
      font-size: 1rem;
      outline: none;
    }

    body.dark input[type="text"] {
      background: #444;
      color: white;
      border: 1px solid #666;
    }

    button {
      margin-left: 0.5rem;
      padding: 0.6rem 1rem;
      border: none;
      background: var(--accent);
      color: white;
      border-radius: 20px;
      font-size: 1rem;
      cursor: pointer;
    }

    button:hover {
      background: #357abd;
    }

    #toggleTheme {
      background: white;
      color: var(--accent);
      font-weight: bold;
      padding: 0.4rem 0.7rem;
      border-radius: 8px;
      border: none;
      margin-left: 1rem;
      cursor: pointer;
    }

    body.dark #toggleTheme {
      background: #444;
      color: white;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <strong>Chat en temps réel</strong><br/>
      <span id="pseudo"></span>
    </div>
    <button id="toggleTheme">🌙</button>
  </header>

  <div id="chat"></div>

  <footer>
    <input type="text" id="messageInput" placeholder="Écris ton message..." />
    <button onclick="sendMessage()">Envoyer</button>
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCQhw69gH9pZDngyp82OS4nKHy_MhbdoE0",
      authDomain: "chat-14381.firebaseapp.com",
      projectId: "chat-14381",
      storageBucket: "chat-14381.firebasestorage.app",
      messagingSenderId: "114036601860",
      appId: "1:114036601860:web:3d792be8e5be3ad1c23151",
      measurementId: "G-W1W14M3J92"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Pseudo
    let pseudo = prompt("Choisis ton pseudo :") || "Anonyme";
    document.getElementById("pseudo").textContent = `Connecté en tant que : ${pseudo}`;

    const chatBox = document.getElementById("chat");

    function sendMessage() {
      const input = document.getElementById("messageInput");
      const message = input.value.trim();
      if (message === '') return;

      db.collection("messages").add({
        pseudo: pseudo,
        message: message,
        timestamp: new Date()
      });

      input.value = '';
      input.focus();
    }

    db.collection("messages")
      .orderBy("timestamp")
      .onSnapshot(snapshot => {
        chatBox.innerHTML = "";
        let lastAuthor = null;
        let lastBubble = null;

        snapshot.forEach(doc => {
          const data = doc.data();
          const isMine = data.pseudo === pseudo;
          const isSameAuthor = data.pseudo === lastAuthor;

          if (isSameAuthor && lastBubble) {
            const msg = document.createElement("div");
            msg.className = "sub-message";
            msg.textContent = data.message;
            lastBubble.querySelector(".messages").appendChild(msg);
          } else {
            const bubble = document.createElement("div");
            bubble.className = `message-block ${isMine ? "mine" : "other"}`;

            bubble.innerHTML = `
              <div class="author">${data.pseudo}<span class="time">${new Date(data.timestamp.toDate()).toLocaleTimeString()}</span></div>
              <div class="messages">
                <div class="sub-message">${data.message}</div>
              </div>
            `;

            chatBox.appendChild(bubble);
            lastBubble = bubble;
          }

          lastAuthor = data.pseudo;
        });

        chatBox.scrollTop = chatBox.scrollHeight;
      });

    document.getElementById("messageInput").addEventListener("keydown", function (e) {
      if (e.key === "Enter") sendMessage();
    });

    // 🌙 Toggle thème
    const toggleButton = document.getElementById("toggleTheme");
    const body = document.body;

    function applyTheme(theme) {
      if (theme === "dark") {
        body.classList.add("dark");
        toggleButton.textContent = "☀️";
      } else {
        body.classList.remove("dark");
        toggleButton.textContent = "🌙";
      }
      localStorage.setItem("theme", theme);
    }

    toggleButton.onclick = () => {
      const newTheme = body.classList.contains("dark") ? "light" : "dark";
      applyTheme(newTheme);
    };

    // Appliquer thème au chargement
    const savedTheme = localStorage.getItem("theme") || "light";
    applyTheme(savedTheme);
  </script>
</body>
</html>
